services:
  attachments-consumer:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-attachments --consumer-group ingest-consumer --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  billing-metrics-consumer:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer billing-metrics-consumer --consumer-group billing-metrics-consumer
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  clickhouse:
    build:
      args:
        BASE_IMAGE: altinity/clickhouse-server:25.3.6.10034.altinitystable
      context: ./clickhouse
    environment:
      MAX_MEMORY_USAGE_RATIO: 0.3
    healthcheck:
      interval: 10s
      retries: 30
      test:
      - CMD-SHELL
      - HTTP_PROXY='' http_proxy='' wget -nv -t1 --spider 'http://localhost:8123/'
        || exit 1
      timeout: 10s
    image: clickhouse-self-hosted-local
    pull_policy: never
    restart: unless-stopped
    ulimits:
      nofile:
        hard: 262144
        soft: 262144
    volumes:
    - sentry-clickhouse:/var/lib/clickhouse
    - sentry-clickhouse-log:/var/log/clickhouse-server
    - read_only: true
      source: ./clickhouse/config.xml
      target: /etc/clickhouse-server/config.d/sentry.xml
      type: bind
    - read_only: true
      source: ./clickhouse/default-password.xml
      target: /etc/clickhouse-server/users.d/default-password.xml
      type: bind
  events-consumer:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-events --consumer-group ingest-consumer --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  generic-metrics-consumer:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-generic-metrics --consumer-group generic-metrics-consumer
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  ingest-feedback-events:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-feedback-events --consumer-group ingest-feedback
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  ingest-monitors:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-monitors --consumer-group ingest-monitors --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  ingest-occurrences:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-occurrences --consumer-group ingest-occurrences --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  ingest-profiles:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-profiles --consumer-group ingest-profiles --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  ingest-replay-recordings:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-replay-recordings --consumer-group ingest-replay-recordings
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  kafka:
    environment:
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
      CONFLUENT_SUPPORT_METRICS_ENABLE: 'false'
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://127.0.0.1:29092,INTERNAL://kafka:9093,EXTERNAL://kafka:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1001@127.0.0.1:29093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,INTERNAL://0.0.0.0:9093,EXTERNAL://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_LOG4J_LOGGERS: kafka.cluster=WARN,kafka.controller=WARN,kafka.coordinator=WARN,kafka.log=WARN,kafka.server=WARN,state.change.logger=WARN
      KAFKA_LOG4J_ROOT_LOGLEVEL: WARN
      KAFKA_LOG_RETENTION_HOURS: '24'
      KAFKA_MAX_REQUEST_SIZE: '50000000'
      KAFKA_MESSAGE_MAX_BYTES: '50000000'
      KAFKA_NODE_ID: '1001'
      KAFKA_OFFSETS_TOPIC_NUM_PARTITIONS: '1'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: '1'
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_TOOLS_LOG4J_LOGLEVEL: WARN
    healthcheck:
      interval: 10s
      retries: 30
      start_period: 600s
      test:
      - CMD-SHELL
      - nc -z localhost 9092
      timeout: 10s
    image: confluentinc/cp-kafka:7.6.6
    restart: unless-stopped
    ulimits:
      nofile:
        hard: 65536
        soft: 65536
    volumes:
    - sentry-kafka:/var/lib/kafka/data
    - sentry-kafka-log:/var/lib/kafka/log
    - sentry-secrets:/etc/kafka/secrets
  memcached:
    command:
    - -I
    - ${SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:-1M}
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test: echo stats | nc 127.0.0.1 11211
      timeout: 1m30s
    image: memcached:1.6.26-alpine
    restart: unless-stopped
  metrics-consumer:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-metrics --consumer-group metrics-consumer --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  monitors-clock-tasks:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer monitors-clock-tasks --consumer-group monitors-clock-tasks
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  monitors-clock-tick:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer monitors-clock-tick --consumer-group monitors-clock-tick
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  nginx:
    depends_on:
      relay:
        condition: service_started
        restart: true
      web:
        condition: service_started
        restart: true
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD
      - /usr/bin/curl
      - http://localhost
      timeout: 1m30s
    image: nginx:1.29.1-alpine
    expose:
    - "80"
    restart: unless-stopped
    volumes:
    - read_only: true
      source: ./nginx.conf
      target: /etc/nginx/nginx.conf
      type: bind
    - sentry-nginx-cache:/var/cache/nginx
    - sentry-nginx-www:/var/www
  pgbouncer:
    depends_on:
      postgres:
        condition: service_started
    environment:
      ADMIN_USERS: postgres,sentry
      AUTH_TYPE: trust
      DB_HOST: postgres
      DB_NAME: postgres
      DB_USER: ${POSTGRES_USER:-postgres}
      MAX_CLIENT_CONN: 10000
      POOL_MODE: transaction
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD-SHELL
      - psql -U postgres -p 5432 -h 127.0.0.1 -tA -c "select 1;" -d postgres >/dev/null
      timeout: 1m30s
    image: edoburu/pgbouncer:v1.24.1-p1
    restart: unless-stopped
  post-process-forwarder-errors:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer --no-strict-offset-reset post-process-forwarder-errors --consumer-group
      post-process-forwarder --synchronize-commit-log-topic=snuba-commit-log --synchronize-commit-group=snuba-consumers
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  post-process-forwarder-issue-platform:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer --no-strict-offset-reset post-process-forwarder-issue-platform
      --consumer-group post-process-forwarder --synchronize-commit-log-topic=snuba-generic-events-commit-log
      --synchronize-commit-group generic_events_group --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  post-process-forwarder-transactions:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer --no-strict-offset-reset post-process-forwarder-transactions
      --consumer-group post-process-forwarder --synchronize-commit-log-topic=snuba-transactions-commit-log
      --synchronize-commit-group transactions_group --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  postgres:
    command:
    - postgres
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER:-postgres}
      timeout: 1m30s
    image: postgres:14.19-bookworm
    restart: unless-stopped
    shm_size: 256m
    volumes:
    - sentry-postgres:/var/lib/postgresql/data
  process-segments:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer --no-strict-offset-reset process-segments --consumer-group
      process-segments --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  process-spans:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer --no-strict-offset-reset process-spans --consumer-group
      process-spans --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  redis:
    command:
    - redis-server
    - /usr/local/etc/redis/redis.conf
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test: redis-cli ping | grep PONG
      timeout: 1m30s
    image: redis:6.2.20-alpine
    restart: unless-stopped
    ulimits:
      nofile:
        hard: 10032
        soft: 10032
    volumes:
    - sentry-redis:/data
    - read_only: true
      source: ./redis.conf
      target: /usr/local/etc/redis/redis.conf
      type: bind
  relay:
    depends_on:
      kafka:
        condition: service_started
      redis:
        condition: service_started
      web:
        condition: service_started
    environment:
      RELAY_STATSD_ADDR: ${STATSD_ADDR:-127.0.0.1:8125}
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD
      - /bin/relay
      - healthcheck
      timeout: 1m30s
    image: ghcr.io/getsentry/relay:nightly
    restart: unless-stopped
    volumes:
    - read_only: true
      source: ./relay
      target: /work/.relay
      type: bind
    - read_only: true
      source: ./geoip
      target: /geoip
      type: bind
  seaweedfs:
    command: server -dir=/data -filer=true -filer.port=8888 -filer.port.grpc=18888
      -filer.defaultReplicaPlacement=000 -master=true -master.port=9333 -master.port.grpc=19333
      -metricsPort=9091 -s3=true -s3.port=8333 -s3.port.grpc=18333 -volume=true -volume.dir.idx=/data/idx
      -volume.index=leveldbLarge -volume.max=0 -volume.preStopSeconds=8 -volume.readMode=redirect
      -volume.port=8080 -volume.port.grpc=18080 -ip=127.0.0.1 -ip.bind=0.0.0.0 -webdav=false
    entrypoint: weed
    environment:
      AWS_ACCESS_KEY_ID: sentry
      AWS_SECRET_ACCESS_KEY: sentry
    healthcheck:
      interval: 60s
      retries: 5
      start_period: 60s
      test:
      - CMD-SHELL
      - http_proxy='' wget -q -O- http://seaweedfs:8080/healthz http://seaweedfs:9333/cluster/healthz
        http://seaweedfs:8333/healthz || exit 1
      timeout: 20s
    image: chrislusf/seaweedfs:3.97_large_disk
    restart: unless-stopped
    volumes:
    - sentry-seaweedfs:/data
  sentry-cleanup:
    build:
      args:
        BASE_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./cron
    command: '"0 0 * * * gosu sentry sentry cleanup --days 90"'
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    image: sentry-cleanup-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  smtp:
    environment:
    - MAILNAME=${SENTRY_MAIL_HOST:-}
    image: registry.gitlab.com/egos-tech/smtp
    restart: unless-stopped
    volumes:
    - sentry-smtp:/var/spool/exim4
    - sentry-smtp-log:/var/log/exim4
  snuba-api:
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD
      - /bin/bash
      - -c
      - 'exec 3<>/dev/tcp/127.0.0.1/1218 && echo -e "GET /health HTTP/1.1\r\nhost:
        127.0.0.1\r\n\r\n" >&3 && grep ok -s -m 1 <&3'
      timeout: 1m30s
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-eap-items-consumer:
    command: rust-consumer --storage eap_items --consumer-group eap_items_group --auto-offset-reset=latest
      --max-batch-time-ms 1000 --no-strict-offset-reset --use-rust-processor --health-check-file
      /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-errors-consumer:
    command: rust-consumer --storage errors --consumer-group snuba-consumers --auto-offset-reset=latest
      --max-batch-time-ms 750 --no-strict-offset-reset --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-generic-metrics-counters-consumer:
    command: rust-consumer --storage generic_metrics_counters_raw --consumer-group
      snuba-gen-metrics-counters-consumers --auto-offset-reset=latest --max-batch-time-ms
      750 --no-strict-offset-reset --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-generic-metrics-distributions-consumer:
    command: rust-consumer --storage generic_metrics_distributions_raw --consumer-group
      snuba-gen-metrics-distributions-consumers --auto-offset-reset=latest --max-batch-time-ms
      750 --no-strict-offset-reset --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-generic-metrics-gauges-consumer:
    command: rust-consumer --storage generic_metrics_gauges_raw --consumer-group snuba-gen-metrics-gauges-consumers
      --auto-offset-reset=latest --max-batch-time-ms 750 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-generic-metrics-sets-consumer:
    command: rust-consumer --storage generic_metrics_sets_raw --consumer-group snuba-gen-metrics-sets-consumers
      --auto-offset-reset=latest --max-batch-time-ms 750 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-group-attributes-consumer:
    command: rust-consumer --storage group_attributes --consumer-group snuba-group-attributes-consumers
      --auto-offset-reset=latest --max-batch-time-ms 750 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-issue-occurrence-consumer:
    command: rust-consumer --storage search_issues --consumer-group generic_events_group
      --auto-offset-reset=latest --max-batch-time-ms 750 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-metrics-consumer:
    command: rust-consumer --storage metrics_raw --consumer-group snuba-metrics-consumers
      --auto-offset-reset=latest --max-batch-time-ms 750 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-outcomes-billing-consumer:
    command: rust-consumer --storage outcomes_raw --consumer-group snuba-consumers
      --auto-offset-reset=earliest --max-batch-time-ms 750 --no-strict-offset-reset
      --raw-events-topic outcomes-billing --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-outcomes-consumer:
    command: rust-consumer --storage outcomes_raw --consumer-group snuba-consumers
      --auto-offset-reset=earliest --max-batch-time-ms 750 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-profiling-functions-consumer:
    command: rust-consumer --storage functions_raw --consumer-group snuba-consumers
      --auto-offset-reset=latest --max-batch-time-ms 1000 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-profiling-profile-chunks-consumer:
    command: rust-consumer --storage profile_chunks --consumer-group snuba-consumers
      --auto-offset-reset=latest --max-batch-time-ms 1000 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-profiling-profiles-consumer:
    command: rust-consumer --storage profiles --consumer-group snuba-consumers --auto-offset-reset=latest
      --max-batch-time-ms 1000 --no-strict-offset-reset --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-replacer:
    command: replacer --storage errors --auto-offset-reset=latest --no-strict-offset-reset
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-replays-consumer:
    command: rust-consumer --storage replays --consumer-group snuba-consumers --auto-offset-reset=latest
      --max-batch-time-ms 750 --no-strict-offset-reset --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-subscription-consumer-eap-items:
    command: subscriptions-scheduler-executor --dataset events_analytics_platform
      --entity eap_items --auto-offset-reset=latest --no-strict-offset-reset --consumer-group=snuba-eap-items-subscriptions-consumers
      --followed-consumer-group=eap_items_group --schedule-ttl=60 --stale-threshold-seconds=900
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-subscription-consumer-events:
    command: subscriptions-scheduler-executor --dataset events --entity events --auto-offset-reset=latest
      --no-strict-offset-reset --consumer-group=snuba-events-subscriptions-consumers
      --followed-consumer-group=snuba-consumers --schedule-ttl=60 --stale-threshold-seconds=900
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    restart: unless-stopped
  snuba-subscription-consumer-generic-metrics-counters:
    command: subscriptions-scheduler-executor --dataset generic_metrics --entity=generic_metrics_counters
      --auto-offset-reset=latest --no-strict-offset-reset --consumer-group=snuba-generic-metrics-counters-subscriptions-schedulers
      --followed-consumer-group=snuba-gen-metrics-counters-consumers --schedule-ttl=60
      --stale-threshold-seconds=900 --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-subscription-consumer-generic-metrics-distributions:
    command: subscriptions-scheduler-executor --dataset generic_metrics --entity=generic_metrics_distributions   --auto-offset-reset=latest
      --no-strict-offset-reset --consumer-group=snuba-generic-metrics-distributions-subscriptions-schedulers
      --followed-consumer-group=snuba-gen-metrics-distributions-consumers --schedule-ttl=60
      --stale-threshold-seconds=900 --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-subscription-consumer-generic-metrics-gauges:
    command: subscriptions-scheduler-executor --dataset generic_metrics --entity=generic_metrics_gauges
      --auto-offset-reset=latest --no-strict-offset-reset --consumer-group=snuba-generic-metrics-gauges-subscriptions-schedulers
      --followed-consumer-group=snuba-gen-metrics-gauges-consumers --schedule-ttl=60
      --stale-threshold-seconds=900 --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-subscription-consumer-generic-metrics-sets:
    command: subscriptions-scheduler-executor --dataset generic_metrics --entity=generic_metrics_sets
      --auto-offset-reset=latest --no-strict-offset-reset --consumer-group=snuba-generic-metrics-sets-subscriptions-schedulers
      --followed-consumer-group=snuba-gen-metrics-sets-consumers --schedule-ttl=60
      --stale-threshold-seconds=900 --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-subscription-consumer-metrics:
    command: subscriptions-scheduler-executor --dataset metrics --entity metrics_sets
      --entity metrics_counters --auto-offset-reset=latest --no-strict-offset-reset
      --consumer-group=snuba-metrics-subscriptions-consumers --followed-consumer-group=snuba-metrics-consumers
      --schedule-ttl=60 --stale-threshold-seconds=900 --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-subscription-consumer-transactions:
    command: subscriptions-scheduler-executor --dataset transactions --entity transactions
      --auto-offset-reset=latest --no-strict-offset-reset --consumer-group=snuba-transactions-subscriptions-consumers
      --followed-consumer-group=transactions_group --schedule-ttl=60 --stale-threshold-seconds=900
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  snuba-transactions-consumer:
    command: rust-consumer --storage transactions --consumer-group transactions_group
      --auto-offset-reset=latest --max-batch-time-ms 750 --no-strict-offset-reset
      --health-check-file /tmp/health.txt
    depends_on:
      clickhouse:
        condition: service_started
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      CLICKHOUSE_HOST: clickhouse
      DEFAULT_BROKERS: kafka:9092
      REDIS_HOST: redis
      SENTRY_EVENT_RETENTION_DAYS:
      SNUBA_SETTINGS: self_hosted
      SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
      UWSGI_DISABLE_LOGGING: 'true'
      UWSGI_MAX_REQUESTS: '10000'
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: ghcr.io/getsentry/snuba:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  subscription-consumer-eap-items:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer subscription-results-eap-items --consumer-group subscription-results-eap-items
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  subscription-consumer-events:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer events-subscription-results --consumer-group query-subscription-consumer
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  subscription-consumer-generic-metrics:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer generic-metrics-subscription-results --consumer-group query-subscription-consumer
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  subscription-consumer-metrics:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer metrics-subscription-results --consumer-group query-subscription-consumer
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  subscription-consumer-transactions:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer transactions-subscription-results --consumer-group query-subscription-consumer
      --healthcheck-file-path /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  symbolicator:
    command: run -c /etc/symbolicator/config.yml
    environment:
      SYMBOLICATOR_STATSD_ADDR: ${STATSD_ADDR:-127.0.0.1:8125}
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD
      - /bin/symbolicator
      - healthcheck
      - -c
      - /etc/symbolicator/config.yml
      timeout: 1m30s
    image: ghcr.io/getsentry/symbolicator:nightly
    restart: unless-stopped
    volumes:
    - sentry-symbolicator:/data
    - read_only: true
      source: ./symbolicator
      target: /etc/symbolicator
      type: bind
  symbolicator-cleanup:
    command: cleanup -c /etc/symbolicator/config.yml --repeat 1h
    environment:
      SYMBOLICATOR_STATSD_ADDR: ${STATSD_ADDR:-127.0.0.1:8125}
    image: ghcr.io/getsentry/symbolicator:nightly
    restart: unless-stopped
    volumes:
    - sentry-symbolicator:/data
    - read_only: true
      source: ./symbolicator
      target: /etc/symbolicator
      type: bind
  taskbroker:
    depends_on:
      kafka:
        condition: service_started
    environment:
      TASKBROKER_DB_PATH: /opt/sqlite/taskbroker-activations.sqlite
      TASKBROKER_KAFKA_CLUSTER: kafka:9092
      TASKBROKER_KAFKA_DEADLETTER_CLUSTER: kafka:9092
      TASKBROKER_STATSD_ADDR: ${STATSD_ADDR:-127.0.0.1:8125}
    image: ghcr.io/getsentry/taskbroker:nightly
    restart: unless-stopped
    volumes:
    - sentry-taskbroker:/opt/sqlite
  taskscheduler:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run taskworker-scheduler
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  taskworker:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run taskworker --concurrency=4 --rpc-host=taskbroker:50051 --health-check-file-path=/tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  transactions-consumer:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer ingest-transactions --consumer-group ingest-consumer --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  uptime-checker:
    command: run
    depends_on:
      kafka:
        condition: service_started
      redis:
        condition: service_started
    environment:
      UPTIME_CHECKER_ALLOW_INTERNAL_IPS: 'false'
      UPTIME_CHECKER_FAILURE_RETRIES: '1'
      UPTIME_CHECKER_REDIS_HOST: redis://redis:6379
      UPTIME_CHECKER_RESULTS_KAFKA_CLUSTER: kafka:9092
      UPTIME_CHECKER_STATSD_ADDR: ${STATSD_ADDR:-127.0.0.1:8125}
    image: ghcr.io/getsentry/uptime-checker:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
  uptime-results:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command: run consumer uptime-results --consumer-group uptime-results --healthcheck-file-path
      /tmp/health.txt
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 3
      start_period: 1200s
      test:
      - CMD-SHELL
      - rm /tmp/health.txt
      timeout: 10s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
  vroom:
    depends_on:
      kafka:
        condition: service_started
    environment:
      AWS_ACCESS_KEY: sentry
      AWS_SECRET_KEY: sentry
      SENTRY_BUCKET_PROFILES: s3://profiles?region=us-east-1&endpoint=seaweedfs:8333&s3ForcePathStyle=true&disableSSL=true
      SENTRY_KAFKA_BROKERS_OCCURRENCES: kafka:9092
      SENTRY_KAFKA_BROKERS_PROFILING: kafka:9092
      SENTRY_SNUBA_HOST: http://snuba-api:1218
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD
      - /bin/bash
      - -c
      - 'exec 3<>/dev/tcp/127.0.0.1/8085 && echo -e "GET /health HTTP/1.1\r\nhost:
        127.0.0.1\r\n\r\n" >&3 && grep OK -s -m 1 <&3'
      timeout: 1m30s
    image: ghcr.io/getsentry/vroom:nightly
    profiles:
    - feature-complete
    restart: unless-stopped
    volumes:
    - sentry-vroom:/var/vroom/sentry-profiles
  vroom-cleanup:
    build:
      args:
        BASE_IMAGE: ghcr.io/getsentry/vroom:nightly
      context: ./cron
    command: '"0 0 * * * find /var/vroom/sentry-profiles -type f -mtime +90
      -delete"'
    entrypoint: /entrypoint.sh
    environment:
      SENTRY_EVENT_RETENTION_DAYS:
    image: vroom-cleanup-self-hosted-local
    profiles:
    - feature-complete
    pull_policy: never
    restart: unless-stopped
    volumes:
    - sentry-vroom:/var/vroom/sentry-profiles
  web:
    build:
      args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
      context: ./sentry
    command:
    - run
    - web
    depends_on:
      kafka:
        condition: service_started
      memcached:
        condition: service_started
      pgbouncer:
        condition: service_started
      redis:
        condition: service_started
      seaweedfs:
        condition: service_started
      smtp:
        condition: service_started
      snuba-api:
        condition: service_started
      symbolicator:
        condition: service_started
    entrypoint: /etc/sentry/entrypoint.sh
    environment:
      COMPOSE_PROFILES:
      DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
      PYTHONUSERBASE: /data/custom-packages
      REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
      SENTRY_CONF: /etc/sentry
      SENTRY_EVENT_RETENTION_DAYS:
      SENTRY_MAIL_HOST:
      SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
      SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
      SENTRY_SYSTEM_SECRET_KEY:
      SNUBA: http://snuba-api:1218
      VROOM: http://vroom:8085
    healthcheck:
      interval: 60s
      retries: 30
      start_period: 600s
      test:
      - CMD
      - /bin/bash
      - -c
      - 'exec 3<>/dev/tcp/127.0.0.1/9000 && echo -e "GET /_health/ HTTP/1.1\r\nhost:
        127.0.0.1\r\n\r\n" >&3 && grep ok -s -m 1 <&3'
      timeout: 1m30s
    image: sentry-self-hosted-local
    platform: ${DOCKER_PLATFORM:-}
    pull_policy: never
    restart: unless-stopped
    ulimits:
      nofile:
        hard: 65536
        soft: 65536
    volumes:
    - sentry-data:/data
    - ./sentry:/etc/sentry
    - ./geoip:/geoip:ro
    - ./certificates:/usr/local/share/ca-certificates:ro
volumes:
  sentry-clickhouse:
  sentry-clickhouse-log:
  sentry-data:
  sentry-kafka:
  sentry-kafka-log:
  sentry-nginx-cache:
  sentry-nginx-www:
  sentry-postgres:
  sentry-redis:
  sentry-seaweedfs:
  sentry-secrets:
  sentry-smtp:
  sentry-smtp-log:
  sentry-symbolicator:
  sentry-taskbroker:
  sentry-vroom:
x-depends_on-default:
  condition: service_started
x-depends_on-healthy:
  condition: service_started
x-file-healthcheck:
  interval: 60s
  retries: 3
  start_period: 1200s
  test:
  - CMD-SHELL
  - rm /tmp/health.txt
  timeout: 10s
x-healthcheck-defaults:
  interval: 60s
  retries: 30
  start_period: 600s
  timeout: 1m30s
x-pull-policy:
  pull_policy: never
x-restart-policy:
  restart: unless-stopped
x-sentry-defaults:
  build:
    args:
        SENTRY_IMAGE: ghcr.io/getsentry/sentry:nightly
    context: ./sentry
  command:
  - run
  - web
  depends_on:
    kafka:
      condition: service_started
    memcached:
      condition: service_started
    pgbouncer:
      condition: service_started
    redis:
      condition: service_started
    seaweedfs:
      condition: service_started
    smtp:
      condition: service_started
    snuba-api:
      condition: service_started
    symbolicator:
      condition: service_started
  entrypoint: /etc/sentry/entrypoint.sh
  environment:
    COMPOSE_PROFILES:
    DEFAULT_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
    GRPC_DEFAULT_SSL_ROOTS_FILE_PATH_ENV_VAR: /etc/ssl/certs/ca-certificates.crt
    PYTHONUSERBASE: /data/custom-packages
    REQUESTS_CA_BUNDLE: /etc/ssl/certs/ca-certificates.crt
    SENTRY_CONF: /etc/sentry
    SENTRY_EVENT_RETENTION_DAYS:
    SENTRY_MAIL_HOST:
    SENTRY_MAX_EXTERNAL_SOURCEMAP_SIZE:
    SENTRY_STATSD_ADDR: ${STATSD_ADDR:-}
    SENTRY_SYSTEM_SECRET_KEY:
    SNUBA: http://snuba-api:1218
    VROOM: http://vroom:8085
  image: sentry-self-hosted-local
  platform: ${DOCKER_PLATFORM:-}
  pull_policy: never
  restart: unless-stopped
  volumes:
  - sentry-data:/data
  - ./sentry:/etc/sentry
  - ./geoip:/geoip:ro
  - ./certificates:/usr/local/share/ca-certificates:ro
x-snuba-defaults:
  depends_on:
    clickhouse:
      condition: service_started
    kafka:
      condition: service_started
    redis:
      condition: service_started
  environment:
    CLICKHOUSE_HOST: clickhouse
    DEFAULT_BROKERS: kafka:9092
    REDIS_HOST: redis
    SENTRY_EVENT_RETENTION_DAYS:
    SNUBA_SETTINGS: self_hosted
    SNUBA_STATSD_ADDR: ${STATSD_ADDR:-}
    UWSGI_DISABLE_LOGGING: 'true'
    UWSGI_MAX_REQUESTS: '10000'
  image: ghcr.io/getsentry/snuba:nightly
  restart: unless-stopped
